<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∑„É≥„Éó„É´wiki</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìö%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        body, textarea {
            font-size: 1.2em;
            margin: 0;
            padding: 0;
        }
        textarea {
            border: none;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
        }
        .keyword-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f0f0f0;
            padding: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }
        .keyword-buttons button {
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .modal-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
        }
        .modal {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }
        .modal button {
            display: block;
            margin-bottom: 10px;
            padding: 8px 16px;
            cursor: pointer;
        }
        @media (min-width: 768px) {
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                background-color: #f9f9f9;
            }
            textarea {
                width: 80%;
                height: 80vh;
            }
        }
    </style>
</head>
<body>
    <textarea id="wiki-text" autofocus></textarea>
    <div class="keyword-buttons" id="keyword-buttons"></div>
    <button class="modal-button" onclick="toggleModal()">‚öôÔ∏è</button>
    <div class="modal" id="modal">
        <button onclick="copyTokenURL()">„Éà„Éº„ÇØ„É≥URL„Çí„Ç≥„Éî„Éº</button>
        <button onclick="downloadArchive()">„Éá„Éº„Çø„Ç¢„Éº„Ç´„Ç§„Éñ„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
    </div>

    <script>
        const textarea = document.getElementById("wiki-text");
        const token = "{{ token }}";
        let timeout;
        let lastTitle = "";

        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„ÅÆÂá¶ÁêÜ
        window.addEventListener("DOMContentLoaded", () => {
            fetch(`/load_last?token=${token}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        textarea.value = `${data.title}\n${data.content}`;
                        lastTitle = data.title;
                    } else {
                        // „É≠„Éº„ÉâÊôÇ„Å´Á©∫Ê¨Ñ„ÅÆÂ†¥Âêà„ÄÅ„Çø„Ç§„Éà„É´‰∏ÄË¶ß„ÇíË°®Á§∫
                        fetch(`/get_titles?token=${token}`)
                            .then(res => res.json())
                            .then(titles => {
                                const buttons = document.getElementById("keyword-buttons");
                                buttons.innerHTML = titles.map(t => `<button onclick="loadPage('${t}')">${t}</button>`).join("");
                            });
                    }
                });
        });

        textarea.addEventListener("keydown", (e) => {
            const lines = textarea.value.split("\n");
            const currentTitle = lines[0] || "";

            // 1Ë°åÁõÆ„ÅåÁ©∫Ê¨Ñ„ÅÆÂ†¥Âêà„ÅØÊîπË°å„ÇíÁÑ°ÂäπÂåñ
            if (lines.length === 1 && currentTitle.trim() === "" && e.key === "Enter") {
                e.preventDefault();
                return;
            }
        });

        textarea.addEventListener("input", () => {
            const lines = textarea.value.split("\n");
            const currentTitle = lines[0] || "";

            // 1Ë°åÁõÆ„ÅÆÂÜÖÂÆπ„ÅåÂ§â„Çè„Å£„Åü„Çâ„Éá„Éº„Çø„ÇíÂëº„Å≥Âá∫„Åô
            if (currentTitle !== lastTitle) {
                lastTitle = currentTitle;
                if (currentTitle.trim() !== "") {
                    fetch(`/load?token=${token}&title=${encodeURIComponent(currentTitle)}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === "success") {
                                textarea.value = `${currentTitle}\n${data.content}`;
                            }
                        });
                }
            }

            clearTimeout(timeout);
            timeout = setTimeout(saveContent, 2000);
        });

        function saveContent() {
            const lines = textarea.value.split("\n");
            const title = lines[0] || "";
            const content = lines.slice(1).join("\n");

            if (!content.trim() || !title.trim()) return;

            fetch("/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token, title, content })
            });
        }

        function detectKeywords() {
            const content = textarea.value;
            const keywords = content.match(/\[([^\]]+)\]/g) || [];
            keywords.forEach(kw => {
                const keyword = kw.slice(1, -1);
                fetch(`/search_keywords?keyword=${encodeURIComponent(keyword)}&token=${token}`)
                    .then(res => res.json())
                    .then(titles => {
                        const buttons = document.getElementById("keyword-buttons");
                        buttons.innerHTML = titles.map(t => `<button onclick="loadPage('${t}')">${t}</button>`).join("");
                    });
            });
        }

        function loadPage(title) {
            fetch(`/load?token=${token}&title=${encodeURIComponent(title)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        textarea.value = `${title}\n${data.content}`;
                        lastTitle = title;
                    }
                });
        }

        function copyTokenURL() {
            navigator.clipboard.writeText(`${window.location.origin}?token=${token}`);
            alert("„Éà„Éº„ÇØ„É≥URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
        }

        function downloadArchive() {
            window.open(`/archive?token=${token}`, "_blank");
        }

        function toggleModal() {
            const modal = document.getElementById("modal");
            modal.style.display = modal.style.display === "block" ? "none" : "block";
        }

        setInterval(detectKeywords, 1000);
    </script>
</body>
</html>
