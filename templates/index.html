<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikiアプリ</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E⏲%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #searchInput {
            width: 100%;
            padding: 10px;
            font-size: 16px;
        }
        #results {
            margin-top: 20px;
        }
        .title-list {
            list-style: none;
            padding: 0;
        }
        .title-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .title-list li:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>Wikiアプリ</h1>
    <input type="text" id="searchInput" placeholder="タイトルを検索...">
    <div id="results">
        <ul class="title-list" id="titleList"></ul>
    </div>

    <script>
        // デバウンス用のタイマー変数
        let debounceTimer;

        // トークンをCookieから取得
        function getToken() {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; token=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        }

        // タイトルを検索し、結果を表示
        function searchTitles(keyword) {
            const token = getToken();
            if (!token) {
                console.error("Token not found");
                return;
            }

            fetch(`/search_keywords?keyword=${encodeURIComponent(keyword)}&token=${encodeURIComponent(token)}`)
                .then(response => response.json())
                .then(titles => {
                    const titleList = document.getElementById('titleList');
                    titleList.innerHTML = '';
                    titles.forEach(title => {
                        const li = document.createElement('li');
                        li.textContent = title;
                        li.addEventListener('click', () => loadTitle(title));
                        titleList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // タイトルをクリックしたときに内容を読み込む
        function loadTitle(title) {
            const token = getToken();
            fetch(`/load?token=${encodeURIComponent(token)}&title=${encodeURIComponent(title)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`タイトル: ${title}\n内容: ${data.content}`);
                    } else {
                        alert('コンテンツが見つかりません');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // デバウンス機能付きの入力イベント
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const keyword = e.target.value.trim();

            // 既存のタイマーをクリア
            clearTimeout(debounceTimer);

            // 新しいタイマーを設定（500ms待機）
            debounceTimer = setTimeout(() => {
                if (keyword.length > 0) {
                    searchTitles(keyword);
                } else {
                    document.getElementById('titleList').innerHTML = '';
                }
            }, 500);
        });
    </script>
</body>
</html>
