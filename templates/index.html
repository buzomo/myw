<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルWiki</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: #f8f9fa; padding: 20px; }
        .search-container { text-align: center; margin-bottom: 20px; }
        #searchBox { width: 100%; max-width: 600px; margin: 0 auto; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; }
        #pageList { max-width: 600px; margin: 0 auto; }
        .page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .page-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .page-content { color: #555; font-size: 14px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        #editor { display: none; max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #editorTitle { width: 100%; font-size: 20px; border: none; outline: none; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }
        #editorContent { width: 100%; min-height: 300px; font-size: 16px; border: none; outline: none; resize: none; }
        #addButton { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: #007bff; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .back-button { color: #0366d6; text-decoration: none; margin-bottom: 16px; display: inline-block; }
        .keyword { color: #0366d6; cursor: pointer; }
        #relatedPages { max-width: 600px; margin: 20px auto; }
        .related-page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .highlight { background-color: #d4edda; font-weight: bold; }
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 1; right: 24px; bottom: 80px; }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 80px; opacity: 1; } }
        @keyframes fadeout { from { bottom: 80px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        .new-page-button { margin-bottom: 16px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="searchBox" placeholder="タイトル・本文を検索...">
    </div>
    <div id="pageList">
        <button class="new-page-button" id="newPageButton">新規ページ</button>
    </div>
    <div id="editor">
        <a href="#" class="back-button" id="backButton">← 一覧に戻る</a>
        <input type="text" id="editorTitle" placeholder="タイトル">
        <textarea id="editorContent" placeholder="本文を入力..."></textarea>
        <div id="relatedPages"></div>
    </div>
    <div id="toast" class="toast"></div>
    <button id="addButton">+</button>
    <script>
        const token = "{{ token }}";
        let lastDeletedPage = null;
        let debounceTimer = null;
        let cachedPages = JSON.parse(localStorage.getItem('cachedPages')) || [];

        // ページ一覧を表示
        function renderPageList(pages, query = '') {
            const pageList = document.getElementById('pageList');
            pageList.innerHTML = '<button class="new-page-button" id="newPageButton">新規ページ</button>' + pages.map(page => {
                const title = highlightKeywords(page.title, query);
                const content = highlightKeywords(page.content, query).replace(/\[([^\]]+)\]/g, '$1');
                return `
                    <div class="page-card" onclick="openEditorFromList('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`)">
                        <div class="page-title">${title}</div>
                        <div class="page-content">${content}</div>
                    </div>
                `;
            }).join('');
        }

        // 関連ページを表示
        function renderRelatedPages(pages, query = '') {
            const relatedPages = document.getElementById('relatedPages');
            if (pages.length > 0) {
                relatedPages.innerHTML = pages.map(page => {
                    const title = highlightKeywords(page.title, query);
                    const content = highlightKeywords(page.content, query).replace(/\[([^\]]+)\]/g, '$1');
                    return `
                        <div class="related-page-card" onclick="openEditor('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`)">
                            <div class="page-title"><a style="color: #0366d6; cursor: pointer;">${title}</a></div>
                            <div class="page-content">${content}</div>
                        </div>
                    `;
                }).join('');
            } else {
                relatedPages.innerHTML = '';
            }
        }

        // キーワードをハイライト
        function highlightKeywords(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.replace(regex, match => `<span class="highlight">${match}</span>`);
        }

        // 特殊文字をエスケープ
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // エディタを開く（ページ一覧から）
        function openEditorFromList(title, content) {
            openEditor(title, content);
            history.pushState(null, null, `#${encodeURIComponent(title)}`);
        }

        // エディタを開く
        function openEditor(title, content) {
            document.getElementById('editorTitle').value = title;
            document.getElementById('editorContent').value = content;
            document.getElementById('pageList').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
            document.getElementById('editorTitle').focus();
            if (title) {
                fetchRelatedPages(title, document.getElementById('searchBox').value);
            }
        }

        // 関連ページを取得
        function fetchRelatedPages(title, query) {
            fetch(`/api/related_pages?token=${token}&title=${encodeURIComponent(title)}`)
                .then(res => res.json())
                .then(pages => renderRelatedPages(pages, query));
        }

        // エディタを閉じる
        function closeEditor() {
            document.getElementById('editor').style.display = 'none';
            document.getElementById('pageList').style.display = 'block';
            history.pushState(null, null, '#');
        }

        // ページを保存
        function savePage() {
            const title = document.getElementById('editorTitle').value;
            const content = document.getElementById('editorContent').value;
            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title, content })
            }).then(() => {
                showToast(`${title}を保存しました`);
                updateCacheAndFetchList();
            });
        }

        // ページ一覧を取得
        function fetchPageList(query = '') {
            fetch(`/api/page_list?token=${token}&query=${query}`)
                .then(res => res.json())
                .then(pages => {
                    cachedPages = pages;
                    localStorage.setItem('cachedPages', JSON.stringify(cachedPages));
                    renderPageList(pages, query);
                    if (pages.length > 0 && !window.location.hash) {
                        openEditorFromList(pages[0].title, pages[0].content);
                    }
                });
        }

        // キャッシュを更新してページ一覧を再取得
        function updateCacheAndFetchList() {
            const query = document.getElementById('searchBox').value;
            fetchPageList(query);
        }

        // ページを削除
        function deletePage(title) {
            fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title })
            }).then(() => {
                showToast(`${title}を削除しました`);
                updateCacheAndFetchList();
                lastDeletedPage = { token, title };
            });
        }

        // トーストを表示
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerHTML = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            // ローカルストレージからキャッシュを読み込み
            if (cachedPages.length > 0) {
                renderPageList(cachedPages);
            }

            // サーバーから最新のページ一覧を取得
            fetchPageList();

            document.getElementById('searchBox').addEventListener('input', (e) => fetchPageList(e.target.value));
            document.getElementById('addButton').addEventListener('click', () => openEditor('', ''));
            document.getElementById('newPageButton').addEventListener('click', () => openEditor('', ''));
            document.getElementById('backButton').addEventListener('click', (e) => { e.preventDefault(); closeEditor(); });

            // 自動保存（デバウンス）
            document.getElementById('editorTitle').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(savePage, 500);
            });
            document.getElementById('editorContent').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(savePage, 500);
            });

            // キーボードショートカット
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 's') { e.preventDefault(); savePage(); }
                if (e.ctrlKey && e.key === 'n') { e.preventDefault(); openEditor('', ''); }
                if (e.key === 'Escape') { closeEditor(); }
            });

            // URLハッシュからページを開く
            if (window.location.hash) {
                const title = decodeURIComponent(window.location.hash.substring(1));
                const cachedPage = cachedPages.find(page => page.title === title);
                if (cachedPage) {
                    openEditorFromList(cachedPage.title, cachedPage.content);
                } else {
                    fetch(`/api/page_content?token=${token}&title=${encodeURIComponent(title)}`)
                        .then(res => res.json())
                        .then(page => openEditorFromList(title, page.content));
                }
            }

            // ブラウザの戻る/進むボタンに対応
            window.addEventListener('popstate', () => {
                if (window.location.hash) {
                    const title = decodeURIComponent(window.location.hash.substring(1));
                    const cachedPage = cachedPages.find(page => page.title === title);
                    if (cachedPage) {
                        openEditorFromList(cachedPage.title, cachedPage.content);
                    } else {
                        fetch(`/api/page_content?token=${token}&title=${encodeURIComponent(title)}`)
                            .then(res => res.json())
                            .then(page => openEditorFromList(title, page.content));
                    }
                } else {
                    closeEditor();
                }
            });
        });
    </script>
</body>
</html>
