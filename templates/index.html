<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìñ%3C/text%3E%3C/svg%3E"
      type="image/svg+xml">
    <title>„Ç∑„É≥„Éó„É´Wiki</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: #f8f9fa; padding: 20px; }
        #pageList { max-width: 600px; margin: 0 auto; }
        .page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .page-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .page-content { color: #555; font-size: 14px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .editor-container { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        .editor-title { width: 100%; font-size: 20px; border: none; outline: none; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .editor-content { width: 100%; min-height: 100px; font-size: 16px; border: none; outline: none; resize: none; overflow-y: auto; }
        .close-button { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: #ccc; }
        .close-button:hover { color: #666; }
        .keyword { color: #0366d6; cursor: pointer; }
        #relatedPages { max-width: 600px; margin: 20px auto; }
        .related-page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .highlight { background-color: #d4edda; font-weight: bold; }
        #searchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 100; }
        #searchModalContent { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; }
        #searchInput { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 16px; }
        #searchResults { max-height: 400px; overflow-y: auto; }
        #newPageCard {
            background: #e9ecef !important;
            color: #495057 !important;
            font-style: italic;
            margin-bottom: 12px;
            text-align: center;
        }
        #newPageCard:hover {
            background: #dee2e6 !important;
        }
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1; right: 30px; bottom: 30px; }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
    </style>
</head>
<body>
    <div id="pageList">
        <div class="page-card" id="newPageCard" onclick="createNewEditor()">
            <div class="page-title">+ Êñ∞Ë¶è„Éö„Éº„Ç∏„Çí‰ΩúÊàê</div>
        </div>
    </div>
    <div id="searchModal">
        <div id="searchModalContent">
            <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢..." autofocus>
            <div id="searchResults"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        const token = "{{ token }}";
        let lastDeletedPage = null;
        let debounceTimer = null;
        let cachedPages = JSON.parse(localStorage.getItem('cachedPages')) || [];

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíË°®Á§∫ÔºàÊú¨Êñá„ÅåÁ©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÈô§Â§ñÔºâ
        function renderPageList(pages) {
            const pageList = document.getElementById('pageList');
            const filteredPages = pages.filter(page => page.content.trim().length > 0);
            let html = `<div class="page-card" id="newPageCard" onclick="createNewEditor()" style="text-align: center; cursor: pointer; background: #e9ecef;">
                            <div class="page-title">+ Êñ∞Ë¶è„Éö„Éº„Ç∏„Çí‰ΩúÊàê</div>
                        </div>`;
            html += filteredPages.map(page => {
                return `
                    <div class="editor-container" data-title="${page.title}">
                        <button class="close-button" onclick="closeEditor('${page.title}')">√ó</button>
                        <input type="text" class="editor-title" value="${page.title}" oninput="updatePageTitle(this, '${page.title}')" placeholder="„Çø„Ç§„Éà„É´">
                        <textarea class="editor-content" oninput="updateEditorHeight(this); extractKeywords(this, '${page.title}')" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ...">${page.content}</textarea>
                        <div class="related-pages" id="relatedPages_${page.title.replace(/\s+/g, '_')}"></div>
                    </div>
                `;
            }).join('');
            pageList.innerHTML = html;
        }

        // Êñ∞Ë¶è„Ç®„Éá„Ç£„Çø„Çí‰ΩúÊàê
        function createNewEditor() {
            const pageList = document.getElementById('pageList');
            const newEditorId = Date.now();
            const newEditorHTML = `
                <div class="editor-container" data-title="">
                    <button class="close-button" onclick="closeEditor('')">√ó</button>
                    <input type="text" class="editor-title" placeholder="„Çø„Ç§„Éà„É´" oninput="updateEditorHeight(this.parentNode.querySelector('.editor-content'))">
                    <textarea class="editor-content" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ..." oninput="updateEditorHeight(this); extractKeywords(this, '')"></textarea>
                    <div class="related-pages" id="relatedPages_${newEditorId}"></div>
                </div>
            `;
            pageList.insertAdjacentHTML('beforeend', newEditorHTML);
            const newEditor = pageList.lastElementChild;
            newEditor.querySelector('.editor-title').focus();
        }

        // „Ç®„Éá„Ç£„Çø„ÇíÈñâ„Åò„Çã
        function closeEditor(title) {
            if (!title && !confirm('Êñ∞Ë¶è„Éö„Éº„Ç∏„ÇíÁ†¥Ê£Ñ„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            const editor = document.querySelector(`.editor-container[data-title="${title}"]`);
            if (editor) {
                editor.remove();
            }
        }

        // „Ç®„Éá„Ç£„Çø„ÅÆÈ´ò„Åï„ÇíÊõ¥Êñ∞
        function updateEditorHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
        function updatePageTitle(input, oldTitle) {
            const newTitle = input.value;
            const editor = input.closest('.editor-container');
            editor.setAttribute('data-title', newTitle);
            savePage(newTitle, editor.querySelector('.editor-content').value, oldTitle);
        }

        // „Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊäΩÂá∫„Åó„Å¶Èñ¢ÈÄ£„Éö„Éº„Ç∏„ÇíË°®Á§∫
        function extractKeywords(textarea, title) {
            const content = textarea.value;
            const keywords = [...new Set(content.match(/\[([^\]]+)\]/g) || [])].map(k => k.slice(1, -1));
            if (keywords.length > 0) {
                const relatedPagesContainer = document.getElementById(`relatedPages_${title.replace(/\s+/g, '_')}`);
                if (relatedPagesContainer) {
                    let html = '';
                    keywords.forEach(keyword => {
                        const existingPage = cachedPages.find(page => page.title === keyword);
                        if (existingPage) {
                            html += `
                                <div class="related-page-card" onclick="openPage('${keyword}')">
                                    <div class="page-title">${keyword}</div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="related-page-card" onclick="createNewEditorWithTitle('${keyword}')">
                                    <div class="page-title">${keyword} (Êñ∞Ë¶è‰ΩúÊàê)</div>
                                </div>
                            `;
                        }
                    });
                    relatedPagesContainer.innerHTML = html;
                }
            }
        }

        // „Çø„Ç§„Éà„É´„ÇíÊåáÂÆö„Åó„Å¶Êñ∞Ë¶è„Ç®„Éá„Ç£„Çø„Çí‰ΩúÊàê
        function createNewEditorWithTitle(title) {
            const pageList = document.getElementById('pageList');
            const newEditorHTML = `
                <div class="editor-container" data-title="${title}">
                    <button class="close-button" onclick="closeEditor('${title}')">√ó</button>
                    <input type="text" class="editor-title" value="${title}" oninput="updatePageTitle(this, '${title}')" placeholder="„Çø„Ç§„Éà„É´">
                    <textarea class="editor-content" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ..." oninput="updateEditorHeight(this); extractKeywords(this, '${title}')"></textarea>
                    <div class="related-pages" id="relatedPages_${title.replace(/\s+/g, '_')}"></div>
                </div>
            `;
            pageList.insertAdjacentHTML('beforeend', newEditorHTML);
        }

        // „Éö„Éº„Ç∏„ÇíÈñã„Åè
        function openPage(title) {
            const existingEditor = document.querySelector(`.editor-container[data-title="${title}"]`);
            if (!existingEditor) {
                const page = cachedPages.find(page => page.title === title);
                if (page) {
                    createNewEditorWithTitle(title);
                    const editor = document.querySelector(`.editor-container[data-title="${title}"]`);
                    editor.querySelector('.editor-content').value = page.content;
                }
            }
        }

        // „Éö„Éº„Ç∏„Çí‰øùÂ≠ò
        function savePage(title, content, oldTitle = null) {
            if (content.trim().length === 0) {
                return;
            }
            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title, content })
            }).then(() => {
                if (oldTitle && oldTitle !== title) {
                    fetch('/api/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token, title: oldTitle })
                    });
                }
                updateCacheAndFetchList();
            });
        }

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂèñÂæó
        function fetchPageList() {
            fetch(`/api/page_list?token=${token}`)
                .then(res => res.json())
                .then(pages => {
                    cachedPages = pages;
                    localStorage.setItem('cachedPages', JSON.stringify(cachedPages));
                    renderPageList(pages);
                });
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞„Åó„Å¶„Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
        function updateCacheAndFetchList() {
            fetchPageList();
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            if (cachedPages.length > 0) {
                renderPageList(cachedPages);
            }
            fetchPageList();
        });
    </script>
</body>
</html>
