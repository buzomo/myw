<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìñ%3C/text%3E%3C/svg%3E"
      type="image/svg+xml">
    <title>„Ç∑„É≥„Éó„É´Wiki</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: #f8f9fa; padding: 20px; }
        #pageList { max-width: 600px; margin: 0 auto; }
        .page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .page-card.selected { background: #ff69b4; color: white; }
        .page-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .page-content { color: #555; font-size: 14px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        #editor { display: none; max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; }
        #editorTitle { width: 100%; font-size: 20px; border: none; outline: none; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }
        #editorContent { width: 100%; min-height: 100px; font-size: 16px; border: none; outline: none; resize: none; overflow-y: auto; }
        .close-button { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; }
        .keyword { color: #0366d6; cursor: pointer; }
        #relatedPages { max-width: 600px; margin: 20px auto; }
        .related-page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .highlight { background-color: #d4edda; font-weight: bold; }
        #searchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 100; }
        #searchModalContent { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; }
        #searchInput { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 16px; }
        #searchResults { max-height: 400px; overflow-y: auto; }
        #newPageCard {
            background: #e9ecef !important;
            color: #495057 !important;
            font-style: italic;
            margin-bottom: 12px;
            text-align: center;
        }
        #newPageCard:hover {
            background: #dee2e6 !important;
        }
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1; right: 30px; bottom: 30px; }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
    </style>
</head>
<body>
    <div id="pageList">
        <div class="page-card" id="newPageCard" onclick="openEditor('', '')">
            <div class="page-title">+ Êñ∞Ë¶è„Éö„Éº„Ç∏„Çí‰ΩúÊàê</div>
        </div>
    </div>
    <div id="editor">
        <button class="close-button" onclick="closeEditor()">√ó</button>
        <input type="text" id="editorTitle" placeholder="„Çø„Ç§„Éà„É´" oninput="updateEditorHeight()">
        <textarea id="editorContent" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ..." oninput="updateEditorHeight(); extractKeywords()"></textarea>
        <div id="relatedPages"></div>
    </div>
    <div id="searchModal">
        <div id="searchModalContent">
            <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢..." autofocus>
            <div id="searchResults"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        const token = "{{ token }}";
        let lastDeletedPage = null;
        let debounceTimer = null;
        let cachedPages = JSON.parse(localStorage.getItem('cachedPages')) || [];
        let selectedIndex = 0;
        let searchSelectedIndex = 0;

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíË°®Á§∫ÔºàÊú¨Êñá„ÅåÁ©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÈô§Â§ñÔºâ
        function renderPageList(pages, query = '') {
            const pageList = document.getElementById('pageList');
            const filteredPages = pages.filter(page => page.content.trim().length > 0);
            let html = `<div class="page-card" id="newPageCard" onclick="openEditor('', '')" style="text-align: center; cursor: pointer; background: #e9ecef;">
                            <div class="page-title">+ Êñ∞Ë¶è„Éö„Éº„Ç∏„Çí‰ΩúÊàê</div>
                        </div>`;
            html += filteredPages.map((page, index) => {
                const title = highlightKeywords(page.title, query);
                const content = highlightKeywords(page.content, query).replace(/\[([^\]]+)\]/g, '$1');
                return `
                    <div class="page-card ${index === selectedIndex ? 'selected' : ''}" onclick="openEditorFromList('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`)" oncontextmenu="deletePageFromList(event, '${page.title}')">
                        <div class="page-title">${title}</div>
                        <div class="page-content">${content}</div>
                    </div>
                `;
            }).join('');
            pageList.innerHTML = html;
        }

        // Èñ¢ÈÄ£„Éö„Éº„Ç∏„ÇíË°®Á§∫ÔºàÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„Éö„Éº„Ç∏„ÇíÈô§Â§ñ„ÄÅÊú¨Êñá„ÅåÁ©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÈô§Â§ñÔºâ
        function renderRelatedPages(pages, currentTitle, query = '') {
            const relatedPages = document.getElementById('relatedPages');
            const filteredPages = pages.filter(page => page.title !== currentTitle && page.content.trim().length > 0);
            if (filteredPages.length > 0) {
                relatedPages.innerHTML = filteredPages.map(page => {
                    const title = highlightKeywords(page.title, query);
                    const content = highlightKeywords(page.content, query).replace(/\[([^\]]+)\]/g, '$1');
                    return `
                        <div class="related-page-card" onclick="openEditor('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`)">
                            <div class="page-title"><a style="color: #0366d6; cursor: pointer;">${title}</a></div>
                            <div class="page-content">${content}</div>
                        </div>
                    `;
                }).join('');
            } else {
                relatedPages.innerHTML = '';
            }
        }

        // „Ç≠„Éº„ÉØ„Éº„Éâ„Çí„Éè„Ç§„É©„Ç§„Éà
        function highlightKeywords(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.replace(regex, match => `<span class="highlight">${match}</span>`);
        }

        // ÁâπÊÆäÊñáÂ≠ó„Çí„Ç®„Çπ„Ç±„Éº„Éó
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // „Ç®„Éá„Ç£„Çø„ÇíÈñã„ÅèÔºà„Éö„Éº„Ç∏‰∏ÄË¶ß„Åã„ÇâÔºâ
        function openEditorFromList(title, content) {
            openEditor(title, content);
            history.pushState(null, null, `#${encodeURIComponent(title)}`);
        }

        // „Ç®„Éá„Ç£„Çø„ÇíÈñã„Åè
        function openEditor(title, content) {
            document.getElementById('editorTitle').value = title;
            document.getElementById('editorContent').value = content;
            document.getElementById('pageList').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
            document.getElementById('editorTitle').focus();
            updateEditorHeight();
            if (title) {
                fetchRelatedPages(title, '');
            }
        }

        // Èñ¢ÈÄ£„Éö„Éº„Ç∏„ÇíÂèñÂæó
        function fetchRelatedPages(title, query) {
            fetch(`/api/related_pages?token=${token}&title=${encodeURIComponent(title)}`)
                .then(res => res.json())
                .then(pages => renderRelatedPages(pages, title, query));
        }

        // „Ç®„Éá„Ç£„Çø„ÇíÈñâ„Åò„Çã
        function closeEditor() {
            document.getElementById('editor').style.display = 'none';
            document.getElementById('pageList').style.display = 'block';
            history.pushState(null, null, '#');
        }

        // „Éö„Éº„Ç∏„Çí‰øùÂ≠ò
        function savePage() {
            const title = document.getElementById('editorTitle').value;
            const content = document.getElementById('editorContent').value;
            if (content.trim().length === 0) {
                return;
            }
            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title, content })
            }).then(() => {
                updateCacheAndFetchList();
            });
        }

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂèñÂæó
        function fetchPageList(query = '') {
            fetch(`/api/page_list?token=${token}&query=${query}`)
                .then(res => res.json())
                .then(pages => {
                    cachedPages = pages;
                    localStorage.setItem('cachedPages', JSON.stringify(cachedPages));
                    renderPageList(pages, query);
                    if (pages.filter(page => page.content.trim().length > 0).length > 0 && !window.location.hash) {
                        document.querySelector('#pageList .page-card:nth-child(2)').classList.add('selected');
                    }
                });
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞„Åó„Å¶„Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
        function updateCacheAndFetchList() {
            fetchPageList();
        }

        // „Éö„Éº„Ç∏„ÇíÂâäÈô§
        function deletePage(title) {
            fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title })
            }).then(() => {
                updateCacheAndFetchList();
                lastDeletedPage = { token, title };
                showToast(`${title} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, () => {
                    if (lastDeletedPage) {
                        fetch('/api/restore', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(lastDeletedPage)
                        }).then(() => {
                            updateCacheAndFetchList();
                            lastDeletedPage = null;
                        });
                    }
                });
            });
        }

        // Âè≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÂâäÈô§
        function deletePageFromList(event, title) {
            event.preventDefault();
            deletePage(title);
        }

        // „Éà„Éº„Çπ„Éà„ÇíË°®Á§∫
        function showToast(message, onClick) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            toast.onclick = onClick;
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }

        // „Ç®„Éá„Ç£„Çø„ÅÆÈ´ò„Åï„ÇíÊõ¥Êñ∞
        function updateEditorHeight() {
            const textarea = document.getElementById('editorContent');
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // „Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊäΩÂá∫„Åó„Å¶Èñ¢ÈÄ£„Éö„Éº„Ç∏„ÇíË°®Á§∫
        function extractKeywords() {
            const content = document.getElementById('editorContent').value;
            const keywords = [...new Set(content.match(/\[([^\]]+)\]/g) || [])].map(k => k.slice(1, -1));
            if (keywords.length > 0) {
                const currentTitle = document.getElementById('editorTitle').value;
                const relatedPages = document.getElementById('relatedPages');
                let html = '';
                keywords.forEach(keyword => {
                    const existingPage = cachedPages.find(page => page.title === keyword);
                    if (existingPage) {
                        html += `
                            <div class="related-page-card" onclick="openEditor('${keyword}', \`${existingPage.content.replace(/`/g, '\\`')}\`)">
                                <div class="page-title">${keyword}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="related-page-card" onclick="openEditor('${keyword}', '')">
                                <div class="page-title">${keyword} (Êñ∞Ë¶è‰ΩúÊàê)</div>
                            </div>
                        `;
                    }
                });
                relatedPages.innerHTML = html;
            }
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            if (cachedPages.length > 0) {
                renderPageList(cachedPages);
            }
            fetchPageList();

            // Ëá™Âãï‰øùÂ≠òÔºà„Éá„Éê„Ç¶„É≥„ÇπÔºâ
            document.getElementById('editorTitle').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(savePage, 500);
            });

            document.getElementById('editorContent').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(savePage, 500);
            });

            // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            document.addEventListener('keydown', (e) => {
                const isEditing = document.activeElement === document.getElementById('editorTitle') || document.activeElement === document.getElementById('editorContent');
                if (isEditing && e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    if (lastDeletedPage) {
                        fetch('/api/restore', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(lastDeletedPage)
                        }).then(() => {
                            updateCacheAndFetchList();
                            lastDeletedPage = null;
                        });
                    }
                    return;
                }

                if (isEditing) {
                    return;
                }

                // „Éà„ÉÉ„Éó„Éö„Éº„Ç∏„ÅÆÊìç‰Ωú
                if (e.key === '/') {
                    e.preventDefault();
                    openSearchModal();
                } else if (e.key === 'n') {
                    e.preventDefault();
                    openEditor('', '');
                } else if (e.key === 'ArrowDown' || e.key === 'j') {
                    e.preventDefault();
                    const cards = document.querySelectorAll('#pageList .page-card');
                    if (cards.length > 1) {
                        cards[selectedIndex + 1]?.classList.remove('selected');
                        selectedIndex = (selectedIndex + 1) % (cards.length - 1);
                        cards[selectedIndex + 1].classList.add('selected');
                        cards[selectedIndex + 1].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                } else if (e.key === 'ArrowUp' || e.key === 'k') {
                    e.preventDefault();
                    const cards = document.querySelectorAll('#pageList .page-card');
                    if (cards.length > 1) {
                        cards[selectedIndex + 1]?.classList.remove('selected');
                        selectedIndex = (selectedIndex - 1 + (cards.length - 1)) % (cards.length - 1);
                        cards[selectedIndex + 1].classList.add('selected');
                        cards[selectedIndex + 1].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                } else if (e.key === 'Enter' || e.key === 'o') {
                    e.preventDefault();
                    const cards = document.querySelectorAll('#pageList .page-card');
                    if (cards.length > 1) {
                        const title = cards[selectedIndex + 1].querySelector('.page-title').textContent;
                        const content = cachedPages.find(page => page.title === title).content;
                        openEditorFromList(title, content);
                    }
                }
            });

            // URL„Éè„ÉÉ„Ç∑„É•„Åã„Çâ„Éö„Éº„Ç∏„ÇíÈñã„Åè
            if (window.location.hash) {
                const title = decodeURIComponent(window.location.hash.substring(1));
                const cachedPage = cachedPages.find(page => page.title === title);
                if (cachedPage) {
                    openEditorFromList(cachedPage.title, cachedPage.content);
                } else {
                    fetch(`/api/page_content?token=${token}&title=${encodeURIComponent(title)}`)
                        .then(res => res.json())
                        .then(page => openEditorFromList(title, page.content));
                }
            }

            // „Éñ„É©„Ç¶„Ç∂„ÅÆÊàª„Çã/ÈÄ≤„ÇÄ„Éú„Çø„É≥„Å´ÂØæÂøú
            window.addEventListener('popstate', () => {
                if (window.location.hash) {
                    const title = decodeURIComponent(window.location.hash.substring(1));
                    const cachedPage = cachedPages.find(page => page.title === title);
                    if (cachedPage) {
                        openEditorFromList(cachedPage.title, cachedPage.content);
                    } else {
                        fetch(`/api/page_content?token=${token}&title=${encodeURIComponent(title)}`)
                            .then(res => res.json())
                            .then(page => openEditorFromList(title, page.content));
                    }
                } else {
                    closeEditor();
                }
            });
        });
    </script>
</body>
</html>
