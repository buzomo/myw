<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルWiki</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: #f8f9fa; padding: 20px; }
        #searchBox { width: 100%; max-width: 600px; margin: 0 auto 20px; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; }
        #pageList { max-width: 600px; margin: 0 auto; }
        .page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .page-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .page-content { color: #555; font-size: 14px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        #editor { display: none; max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #editorTitle { width: 100%; font-size: 20px; border: none; outline: none; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }
        #editorContent { width: 100%; min-height: 300px; font-size: 16px; border: none; outline: none; resize: none; }
        #addButton { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: #007bff; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .back-button { color: #0366d6; text-decoration: none; margin-bottom: 16px; display: inline-block; }
        .keyword { color: #0366d6; cursor: pointer; }
    </style>
</head>
<body>
    <input type="text" id="searchBox" placeholder="タイトル・本文を検索...">
    <div id="pageList"></div>
    <div id="editor">
        <a href="#" class="back-button" id="backButton">← 一覧に戻る</a>
        <input type="text" id="editorTitle" placeholder="タイトル">
        <textarea id="editorContent" placeholder="本文を入力..."></textarea>
    </div>
    <button id="addButton">+</button>
    <script>
        const token = "{{ token }}";
        // ページ一覧を表示
        function renderPageList(pages) {
            const pageList = document.getElementById('pageList');
            pageList.innerHTML = pages.map(page =>
                `<div class="page-card" onclick="openEditor('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`)">
                    <div class="page-title">${page.title}</div>
                    <div class="page-content">${page.content.replace(/\[([^\]]+)\]/g, '<span class="keyword">[$1]</span>')}</div>
                </div>`
            ).join('');
        }
        // エディタを開く
        function openEditor(title, content) {
            document.getElementById('editorTitle').value = title;
            document.getElementById('editorContent').value = content;
            document.getElementById('pageList').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
        }
        // エディタを閉じる
        function closeEditor() {
            document.getElementById('editor').style.display = 'none';
            document.getElementById('pageList').style.display = 'block';
        }
        // ページを保存
        function savePage() {
            const title = document.getElementById('editorTitle').value;
            const content = document.getElementById('editorContent').value;
            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title, content })
            }).then(() => {
                closeEditor();
                fetchPageList();
            });
        }
        // ページ一覧を取得
        function fetchPageList(query = '') {
            fetch(`/api/page_list?token=${token}&query=${query}`)
                .then(res => res.json())
                .then(renderPageList);
        }
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            fetchPageList();
            document.getElementById('searchBox').addEventListener('input', (e) => fetchPageList(e.target.value));
            document.getElementById('addButton').addEventListener('click', () => openEditor('', ''));
            document.getElementById('backButton').addEventListener('click', (e) => { e.preventDefault(); closeEditor(); });
            document.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 's') { e.preventDefault(); savePage(); } });
        });
    </script>
</body>
</html>
