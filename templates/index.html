<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìñ%3C/text%3E%3C/svg%3E"
      type="image/svg+xml">
    <title>„Ç∑„É≥„Éó„É´Wiki</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }
        body {
            background: #f8f9fa;
            padding: 20px;
        }
        #pageList {
            max-width: 600px;
            margin: 0 auto;
        }
        .editor-container {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .editor-title {
            width: 100%;
            font-size: 20px;
            border: none;
            outline: none;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .editor-content {
            width: 100%;
            min-height: auto;
            font-size: 16px;
            border: none;
            outline: none;
            resize: none;
            overflow-y: hidden;
            line-height: 1.5;
        }
        .related-pages {
            margin-top: 12px;
        }
        .related-page-card {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 6px;
            cursor: pointer;
            display: inline-block;
            margin-right: 6px;
            font-size: 14px;
        }
        .related-page-card:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <div id="pageList">
        <div class="editor-container" data-title="">
            <input type="text" class="editor-title" placeholder="„Çø„Ç§„Éà„É´" oninput="updatePageTitle(this)">
            <textarea class="editor-content" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ..." oninput="autoResize(this); extractKeywords(this)"></textarea>
            <div class="related-pages"></div>
        </div>
    </div>
    <script>
        const token = "{{ token }}";
        let cachedPages = JSON.parse(localStorage.getItem('cachedPages')) || [];

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíË°®Á§∫ÔºàÊú¨Êñá„ÅåÁ©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÈô§Â§ñÔºâ
        function renderPageList(pages) {
            const pageList = document.getElementById('pageList');
            const filteredPages = pages.filter(page => page.content.trim().length > 0);
            let html = '';
            filteredPages.forEach(page => {
                html += `
                    <div class="editor-container" data-title="${page.title}">
                        <input type="text" class="editor-title" value="${page.title}" oninput="updatePageTitle(this)" placeholder="„Çø„Ç§„Éà„É´">
                        <textarea class="editor-content" oninput="autoResize(this); extractKeywords(this)" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ...">${page.content}</textarea>
                        <div class="related-pages" id="relatedPages_${page.title.replace(/\s+/g, '_')}"></div>
                    </div>
                `;
            });
            pageList.innerHTML += html;
        }

        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÈ´ò„Åï„ÇíËá™ÂãïË™øÊï¥
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
        function updatePageTitle(input) {
            const editor = input.closest('.editor-container');
            const title = input.value;
            const content = editor.querySelector('.editor-content').value;
            editor.setAttribute('data-title', title);
            savePage(title, content);
        }

        // „Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊäΩÂá∫„Åó„Å¶Èñ¢ÈÄ£„Éö„Éº„Ç∏„ÇíË°®Á§∫
        function extractKeywords(textarea) {
            const editor = textarea.closest('.editor-container');
            const title = editor.getAttribute('data-title');
            const content = textarea.value;
            const keywords = [...new Set(content.match(/\[([^\]]+)\]/g) || [])].map(k => k.slice(1, -1));
            const relatedPagesContainer = editor.querySelector('.related-pages');
            if (keywords.length > 0) {
                let html = '';
                keywords.forEach(keyword => {
                    const existingPage = cachedPages.find(page => page.title === keyword);
                    if (existingPage) {
                        html += `<div class="related-page-card" onclick="focusPage('${keyword}')">${keyword}</div>`;
                    } else {
                        html += `<div class="related-page-card" onclick="createEditorWithTitle('${keyword}')">${keyword} (Êñ∞Ë¶è)</div>`;
                    }
                });
                relatedPagesContainer.innerHTML = html;
            } else {
                relatedPagesContainer.innerHTML = '';
            }
        }

        // ÊåáÂÆö„Åó„Åü„Çø„Ç§„Éà„É´„ÅÆ„Ç®„Éá„Ç£„Çø„Å´„Éï„Ç©„Éº„Ç´„Çπ
        function focusPage(title) {
            const editors = document.querySelectorAll('.editor-container');
            for (const editor of editors) {
                if (editor.getAttribute('data-title') === title) {
                    editor.querySelector('.editor-content').focus();
                    return;
                }
            }
            // Â≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è„Ç®„Éá„Ç£„Çø„Çí‰ΩúÊàê
            createEditorWithTitle(title);
        }

        // „Çø„Ç§„Éà„É´„ÇíÊåáÂÆö„Åó„Å¶Êñ∞Ë¶è„Ç®„Éá„Ç£„Çø„Çí‰ΩúÊàê
        function createEditorWithTitle(title) {
            const pageList = document.getElementById('pageList');
            const existingPage = cachedPages.find(page => page.title === title);
            const content = existingPage ? existingPage.content : '';
            const newEditorHTML = `
                <div class="editor-container" data-title="${title}">
                    <input type="text" class="editor-title" value="${title}" oninput="updatePageTitle(this)" placeholder="„Çø„Ç§„Éà„É´">
                    <textarea class="editor-content" oninput="autoResize(this); extractKeywords(this)" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ...">${content}</textarea>
                    <div class="related-pages" id="relatedPages_${title.replace(/\s+/g, '_')}"></div>
                </div>
            `;
            pageList.insertAdjacentHTML('beforeend', newEditorHTML);
            const newEditor = pageList.lastElementChild;
            newEditor.querySelector('.editor-content').focus();
        }

        // „Éö„Éº„Ç∏„Çí‰øùÂ≠ò
        function savePage(title, content) {
            if (content.trim().length === 0 && title.trim().length === 0) {
                return;
            }
            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title, content })
            }).then(() => {
                updateCacheAndFetchList();
            });
        }

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂèñÂæó
        function fetchPageList() {
            fetch(`/api/page_list?token=${token}`)
                .then(res => res.json())
                .then(pages => {
                    cachedPages = pages;
                    localStorage.setItem('cachedPages', JSON.stringify(cachedPages));
                    renderPageList(pages);
                });
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞„Åó„Å¶„Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
        function updateCacheAndFetchList() {
            fetchPageList();
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            fetchPageList();
        });
    </script>
</body>
</html>
