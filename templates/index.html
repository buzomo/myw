<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìñ%3C/text%3E%3C/svg%3E"
      type="image/svg+xml">
    <title>„Ç∑„É≥„Éó„É´Wiki</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background: #f8f9fa; padding: 20px; }
        #pageList { max-width: 600px; margin: 0 auto; }
        .page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .page-card.selected { background: #ff69b4; color: white; }
        .page-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .page-content { color: #555; font-size: 14px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        #editor { display: none; max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #editorTitle { width: 100%; font-size: 20px; border: none; outline: none; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }
        #editorContent { width: 100%; min-height: 300px; font-size: 16px; border: none; outline: none; resize: none; }
        .back-button { color: #0366d6; text-decoration: none; margin-bottom: 16px; display: inline-block; }
        .keyword { color: #0366d6; cursor: pointer; }
        #relatedPages { max-width: 600px; margin: 20px auto; }
        .related-page-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .highlight { background-color: #d4edda; font-weight: bold; }
        #searchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 100; }
        #searchModalContent { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; }
        #searchInput { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 16px; }
        #searchResults { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="pageList"></div>
    <div id="editor">
        <a href="#" class="back-button" id="backButton">‚Üê ‰∏ÄË¶ß„Å´Êàª„Çã</a>
        <input type="text" id="editorTitle" placeholder="„Çø„Ç§„Éà„É´">
        <textarea id="editorContent" placeholder="Êú¨Êñá„ÇíÂÖ•Âäõ..."></textarea>
        <div id="relatedPages"></div>
    </div>
    <div id="searchModal">
        <div id="searchModalContent">
            <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢..." autofocus>
            <div id="searchResults"></div>
        </div>
    </div>
    <script>
        const token = "{{ token }}";
        let lastDeletedPage = null;
        let debounceTimer = null;
        let cachedPages = JSON.parse(localStorage.getItem('cachedPages')) || [];
        let selectedIndex = 0;
        let searchSelectedIndex = 0;

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíË°®Á§∫
        function renderPageList(pages, query = '') {
            const pageList = document.getElementById('pageList');
            pageList.innerHTML = pages.map((page, index) => {
                const title = highlightKeywords(page.title, query);
                const content = highlightKeywords(page.content, query).replace(/\[([^\]]+)\]/g, '$1');
                return `
                    <div class="page-card ${index === selectedIndex ? 'selected' : ''}" onclick="openEditorFromList('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`)">
                        <div class="page-title">${title}</div>
                        <div class="page-content">${content}</div>
                    </div>
                `;
            }).join('');
        }

        // Èñ¢ÈÄ£„Éö„Éº„Ç∏„ÇíË°®Á§∫ÔºàÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„Éö„Éº„Ç∏„ÇíÈô§Â§ñÔºâ
        function renderRelatedPages(pages, currentTitle, query = '') {
            const relatedPages = document.getElementById('relatedPages');
            const filteredPages = pages.filter(page => page.title !== currentTitle);
            if (filteredPages.length > 0) {
                relatedPages.innerHTML = filteredPages.map(page => {
                    const title = highlightKeywords(page.title, query);
                    const content = highlightKeywords(page.content, query).replace(/\[([^\]]+)\]/g, '$1');
                    return `
                        <div class="related-page-card" onclick="openEditor('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`)">
                            <div class="page-title"><a style="color: #0366d6; cursor: pointer;">${title}</a></div>
                            <div class="page-content">${content}</div>
                        </div>
                    `;
                }).join('');
            } else {
                relatedPages.innerHTML = '';
            }
        }

        // „Ç≠„Éº„ÉØ„Éº„Éâ„Çí„Éè„Ç§„É©„Ç§„Éà
        function highlightKeywords(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
            return text.replace(regex, match => `<span class="highlight">${match}</span>`);
        }

        // ÁâπÊÆäÊñáÂ≠ó„Çí„Ç®„Çπ„Ç±„Éº„Éó
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // „Ç®„Éá„Ç£„Çø„ÇíÈñã„ÅèÔºà„Éö„Éº„Ç∏‰∏ÄË¶ß„Åã„ÇâÔºâ
        function openEditorFromList(title, content) {
            openEditor(title, content);
            history.pushState(null, null, `#${encodeURIComponent(title)}`);
        }

        // „Ç®„Éá„Ç£„Çø„ÇíÈñã„Åè
        function openEditor(title, content) {
            document.getElementById('editorTitle').value = title;
            document.getElementById('editorContent').value = content;
            document.getElementById('pageList').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
            document.getElementById('editorTitle').focus();
            if (title) {
                fetchRelatedPages(title, '');
            }
        }

        // Èñ¢ÈÄ£„Éö„Éº„Ç∏„ÇíÂèñÂæó
        function fetchRelatedPages(title, query) {
            fetch(`/api/related_pages?token=${token}&title=${encodeURIComponent(title)}`)
                .then(res => res.json())
                .then(pages => renderRelatedPages(pages, title, query));
        }

        // „Ç®„Éá„Ç£„Çø„ÇíÈñâ„Åò„Çã
        function closeEditor() {
            document.getElementById('editor').style.display = 'none';
            document.getElementById('pageList').style.display = 'block';
            history.pushState(null, null, '#');
        }

        // „Éö„Éº„Ç∏„Çí‰øùÂ≠ò
        function savePage() {
            const title = document.getElementById('editorTitle').value;
            const content = document.getElementById('editorContent').value;
            fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title, content })
            }).then(() => {
                updateCacheAndFetchList();
            });
        }

        // „Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂèñÂæó
        function fetchPageList(query = '') {
            fetch(`/api/page_list?token=${token}&query=${query}`)
                .then(res => res.json())
                .then(pages => {
                    cachedPages = pages;
                    localStorage.setItem('cachedPages', JSON.stringify(cachedPages));
                    renderPageList(pages, query);
                    if (pages.length > 0 && !window.location.hash) {
                        document.querySelector('.page-card').classList.add('selected');
                    }
                });
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞„Åó„Å¶„Éö„Éº„Ç∏‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
        function updateCacheAndFetchList() {
            fetchPageList();
        }

        // „Éö„Éº„Ç∏„ÇíÂâäÈô§
        function deletePage(title) {
            fetch('/api/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, title })
            }).then(() => {
                updateCacheAndFetchList();
                lastDeletedPage = { token, title };
            });
        }

        // Ê§úÁ¥¢„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openSearchModal() {
            document.getElementById('searchModal').style.display = 'block';
            document.getElementById('searchInput').focus();
        }

        // Ê§úÁ¥¢„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // Ê§úÁ¥¢ÁµêÊûú„ÇíË°®Á§∫
        function searchPages(query) {
            const results = cachedPages.filter(page =>
                page.title.includes(query) || page.content.includes(query)
            );
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = results.map((page, index) => {
                const title = highlightKeywords(page.title, query);
                const content = highlightKeywords(page.content, query).replace(/\[([^\]]+)\]/g, '$1');
                return `
                    <div class="page-card ${index === searchSelectedIndex ? 'selected' : ''}" onclick="openEditorFromList('${page.title}', \`${page.content.replace(/`/g, '\\`')}\`); closeSearchModal();">
                        <div class="page-title">${title}</div>
                        <div class="page-content">${content}</div>
                    </div>
                `;
            }).join('');
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            if (cachedPages.length > 0) {
                renderPageList(cachedPages);
            }
            fetchPageList();
            document.getElementById('backButton').addEventListener('click', (e) => { e.preventDefault(); closeEditor(); });

            // Ëá™Âãï‰øùÂ≠òÔºà„Éá„Éê„Ç¶„É≥„ÇπÔºâ
            document.getElementById('editorTitle').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(savePage, 500);
            });
            document.getElementById('editorContent').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(savePage, 500);
            });

            // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            document.addEventListener('keydown', (e) => {
                const isEditing = document.activeElement === document.getElementById('editorTitle') || document.activeElement === document.getElementById('editorContent');
                const isSearching = document.getElementById('searchModal').style.display === 'block';

                if (isEditing) {
                    return;
                }

                // Ê§úÁ¥¢„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÊìç‰Ωú
                if (isSearching) {
                    if (e.key === 'Escape') {
                        closeSearchModal();
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const cards = document.querySelectorAll('#searchResults .page-card');
                        if (cards.length > 0) {
                            cards[searchSelectedIndex]?.classList.remove('selected');
                            searchSelectedIndex = (searchSelectedIndex + 1) % cards.length;
                            cards[searchSelectedIndex].classList.add('selected');
                            cards[searchSelectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const cards = document.querySelectorAll('#searchResults .page-card');
                        if (cards.length > 0) {
                            cards[searchSelectedIndex]?.classList.remove('selected');
                            searchSelectedIndex = (searchSelectedIndex - 1 + cards.length) % cards.length;
                            cards[searchSelectedIndex].classList.add('selected');
                            cards[searchSelectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        const cards = document.querySelectorAll('#searchResults .page-card');
                        if (cards.length > 0) {
                            const title = cards[searchSelectedIndex].querySelector('.page-title').textContent;
                            const content = cachedPages.find(page => page.title === title).content;
                            openEditorFromList(title, content);
                            closeSearchModal();
                        }
                    }
                    return;
                }

                // „Éà„ÉÉ„Éó„Éö„Éº„Ç∏„ÅÆÊìç‰Ωú
                if (e.key === '/') {
                    e.preventDefault();
                    openSearchModal();
                } else if (e.key === 'n') {
                    e.preventDefault();
                    openEditor('', '');
                } else if (e.key === 'ArrowDown' || e.key === 'j') {
                    e.preventDefault();
                    const cards = document.querySelectorAll('#pageList .page-card');
                    if (cards.length > 0) {
                        cards[selectedIndex]?.classList.remove('selected');
                        selectedIndex = (selectedIndex + 1) % cards.length;
                        cards[selectedIndex].classList.add('selected');
                        cards[selectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                } else if (e.key === 'ArrowUp' || e.key === 'k') {
                    e.preventDefault();
                    const cards = document.querySelectorAll('#pageList .page-card');
                    if (cards.length > 0) {
                        cards[selectedIndex]?.classList.remove('selected');
                        selectedIndex = (selectedIndex - 1 + cards.length) % cards.length;
                        cards[selectedIndex].classList.add('selected');
                        cards[selectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                } else if (e.key === 'Enter' || e.key === 'o') {
                    e.preventDefault();
                    const cards = document.querySelectorAll('#pageList .page-card');
                    if (cards.length > 0) {
                        const title = cards[selectedIndex].querySelector('.page-title').textContent;
                        const content = cachedPages.find(page => page.title === title).content;
                        openEditorFromList(title, content);
                    }
                } else if (e.key === 'x') {
                    e.preventDefault();
                    const cards = document.querySelectorAll('#pageList .page-card');
                    if (cards.length > 0) {
                        const title = cards[selectedIndex].querySelector('.page-title').textContent;
                        if (confirm(`${title}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                            deletePage(title);
                        }
                    }
                }
            });

            // Ê§úÁ¥¢ÂÖ•ÂäõÊôÇ„ÅÆÂá¶ÁêÜ
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchPages(e.target.value);
                searchSelectedIndex = 0;
            });

            // URL„Éè„ÉÉ„Ç∑„É•„Åã„Çâ„Éö„Éº„Ç∏„ÇíÈñã„Åè
            if (window.location.hash) {
                const title = decodeURIComponent(window.location.hash.substring(1));
                const cachedPage = cachedPages.find(page => page.title === title);
                if (cachedPage) {
                    openEditorFromList(cachedPage.title, cachedPage.content);
                } else {
                    fetch(`/api/page_content?token=${token}&title=${encodeURIComponent(title)}`)
                        .then(res => res.json())
                        .then(page => openEditorFromList(title, page.content));
                }
            }

            // „Éñ„É©„Ç¶„Ç∂„ÅÆÊàª„Çã/ÈÄ≤„ÇÄ„Éú„Çø„É≥„Å´ÂØæÂøú
            window.addEventListener('popstate', () => {
                if (window.location.hash) {
                    const title = decodeURIComponent(window.location.hash.substring(1));
                    const cachedPage = cachedPages.find(page => page.title === title);
                    if (cachedPage) {
                        openEditorFromList(cachedPage.title, cachedPage.content);
                    } else {
                        fetch(`/api/page_content?token=${token}&title=${encodeURIComponent(title)}`)
                            .then(res => res.json())
                            .then(page => openEditorFromList(title, page.content));
                    }
                } else {
                    closeEditor();
                }
            });
        });
    </script>
</body>
</html>
